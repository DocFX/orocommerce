{% import 'OroUIBundle::macros.html.twig' as UI %}
{% import 'OroProductBundle::image_macros.html.twig' as Image %}

{% set lineItems = record.getValue('lineItems') %}
{% set firstLineItem = lineItems|first %}
{% set mainProduct = firstLineItem.parentProduct|default(firstLineItem.product) %}

{% set productImageData = mainProduct.imagesByType('listing').first.image|default(null) %}

<div class="product-item">
    <div class="grid-line-items">
        <div class="grid-line-items__row grid-line-items__row--offset-y-end">
            {% if productImageData %}
                {% set productUniqId = 'product-'|uniqid %}
                <div class="product-item__image-holder--aspect-ratio product-item__image-holder--tiny">
                    <div {{ UI.attributes({
                        'class': 'product-item__preview',
                        'data-page-component-module': 'orofrontend/js/app/components/popup-gallery-widget',
                        'data-page-component-options': {
                            ajaxMode: true,
                            ajaxRoute: 'oro_product_frontend_ajax_images_by_id',
                            id: mainProduct.id,
                            galleryFilter: 'product_gallery_popup',
                            alt: mainProduct.names|localized_value,
                            uniqueTriggerToOpenGallery: '[data-role="data-trigger-gallery-open-' ~ productUniqId ~ '"]'
                        }|json_encode
                    }) }}>
                        <picture class="product-item__preview-picture" data-object-fit="">
                            {{ Image.image(productImageData, 'product_small', {
                                class: 'product-item__preview-image',
                                alt: mainProduct.names|localized_value|e
                            }) }}
                        </picture>
                    </div>
                    <button class="view-product-gallery stretched" data-role="{{'data-trigger-gallery-open-' ~ productUniqId }}" aria-label="{{ 'oro.product.images.zoom.label'|trans }}">
                        <span class="view-product-gallery__icon" aria-hidden="true"></span>
                    </button>
                </div>
            {% else %}
                <div class="product-item__image-holder product-item__image-holder--tiny">
                    {{ Image.image(productImageData, 'product_small', {
                        class: 'product-item__preview-image',
                        alt: mainProduct.names|localized_value|e
                    }) }}
                </div>
            {% endif %}
        </div>
        <div class="grid-line-items__row">
            {% set clipLength = 30 %}
            <div class="grid-line-items__row-item">
                {% set mainProductName = mainProduct.names|localized_value|e %}
                {% set productNameClipClassName = '' %}
                {% if mainProductName|length < clipLength %}
                    {% block product_name %}
                        <h3 class="grid-line-items__title {{ productNameClipClassName }}">
                            <a{% if productNameLinkClipClassName is defined %} class="{{ productNameLinkClipClassName }}"{% endif %}
                                href="{{ path('oro_product_frontend_product_view', {'id': mainProduct.id}) }}"
                                title="{{ mainProductName }}">{{ mainProductName }}</a>
                        </h3>
                    {% endblock %}
                {% else %}
                    {% set productNameClipClassName = 'grid-line-items__clip-placeholder' %}
                    {% set productNameLinkClipClassName = 'grid-line-items__ellipsis' %}
                    <div class="grid-line-items__clip-title-container">
                        {{ block('product_name') }}
                    </div>
                {% endif %}
            </div>
            {% if firstLineItem.notes is defined and firstLineItem.notes|length > 0 %}
                <div class="grid-line-items__row-item">
                    {% set productNoteClipClassName = '' %}
                    {% if firstLineItem.notes|length < clipLength %}
                        {% block product_notes %}
                            <div class="grid-line-items__text {{ productNoteClipClassName }}" data-role="note">{{ firstLineItem.notes }}</div>
                        {% endblock %}
                    {% else %}
                        {% set productNoteClipClassName = 'grid-line-items__ellipsis' %}
                        <div class="grid-line-items__clip-text-container" data-page-component-view="oroshoppinglist/js/app/views/preview-full-note-view">
                            <div class="grid-line-items__clip-placeholder">
                                {{ block('product_notes') }}
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

    {# Will be refactored at BB-19262 #}
    {% if firstLineItem.parentProduct is not empty %}
        {% set configurableProducts = record.getValue('configurableProducts') %}
        <br>
        <br>
        <br>
        {% for lineItem in lineItems %}
            <div>
                {% for field in configurableProducts[lineItem.product.id] ?? [] %}
                    <span>{{ field.label|trans }}: {{ field.value }}</span>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </div>
            <div class="shopping-list-line-items__note">
                {{ lineItem.notes }}
            </div>
            {% if not loop.last %}
                <hr>
            {% endif %}
        {% endfor %}
    {% endif %}
    {# Will be refactored at BB-19262 END #}
</div>
